<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K-SNACK MERGE!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            background: radial-gradient(circle at 50% 30%, #fff5e6 0%, #ffe0b2 40%, #ffcc80 80%, #f57c00 100%);
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 2px 0 25px 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none; -webkit-user-select: none; touch-action: none;
            overflow-x: hidden; overflow-y: auto; overscroll-behavior-y: none; 
            min-height: 100dvh;
        }
        
        #app-grid {
            display: grid; 
            grid-template-columns: 100px minmax(0, 360px); 
            grid-template-rows: auto auto auto auto;
            gap: 2px 15px; justify-content: center; width: 100%; padding: 0 10px; box-sizing: border-box;
        }

        #game-title {
            grid-column: 1 / -1; 
            justify-self: center; 
            margin: 2px 0 0px 0; color: #fff; font-size: 26px; font-weight: normal; 
            text-shadow: 3px 3px 0px #d35400, 0px 4px 8px rgba(0,0,0,0.3); 
            letter-spacing: 1px; font-family: 'Bungee', cursive;
        }

        #stats-board { 
            grid-column: 1 / -1; 
            justify-self: center; 
            display: flex; gap: 4px; position: relative; z-index: 10; 
            flex-wrap: wrap; justify-content: center;
        }
        
        .stat-box { 
            /* ğŸ’¡ ì „ì²´ í°íŠ¸ í¬ê¸° 14px -> 12px ì¶•ì†Œ, ì¢Œìš° ì—¬ë°± 12px -> 6px ì¶•ì†Œ */
            font-size: 12px; font-weight: 900; color: #fff; background: rgba(139, 69, 19, 0.7); 
            padding: 3px 6px; 
            border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 2px 4px rgba(255,255,255,0.2); 
            border: 2px solid #ffffff; font-family: 'Jua', sans-serif; letter-spacing: 0.5px; 
            display: flex; align-items: center; justify-content: center;
        }
        .stat-box.high { background: #d35400; border-color: #f1c40f; color: #fffaf0; }
        
        /* ğŸ›’ ìƒì  ë²„íŠ¼ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        #shop-btn {
            background: #FFD700; color: #8B4513; border-color: #DAA520; cursor: pointer;
            transition: transform 0.1s; text-shadow: 0 1px 1px rgba(255,255,255,0.8);
        }
        #shop-btn:active { transform: scale(0.95); }

        #side-panel { grid-column: 1; grid-row: 3; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding-top: 70px; padding-bottom: 25px; }
        
        #next-snack-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        
        .side-title { color: #d35400; font-size: 15px; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(255,255,255,0.8); text-align: center; font-family: 'Jua', sans-serif; }
        
        #next-snack-bubble { width: 70px; height: 70px; position: relative; border-radius: 48% 52% 45% 55% / 55% 45% 50% 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.1) 30%, transparent 60%, rgba(255,255,255,0.3) 100%); box-shadow: inset -2px -2px 6px rgba(255,255,255,0.4), inset 3px 3px 10px rgba(255,255,255,0.8), 0 8px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: center; animation: floatBubble 3s ease-in-out infinite; }
        #next-snack-bubble::after { content: ''; position: absolute; top: 8px; left: 10px; width: 10px; height: 5px; background: rgba(255,255,255,0.9); border-radius: 50%; transform: rotate(-30deg); box-shadow: 0 0 5px rgba(255,255,255,0.8); }
        
        #next-snack-img { width: 45px; height: 45px; object-fit: contain; z-index: 2; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        @keyframes floatBubble { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        #evolution-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
        #evolution-chain { display: flex; flex-direction: column; gap: 2px; justify-content: flex-start; align-items: center; background: linear-gradient(to bottom, #ffeaa7, #fab1a0, #e17055, #c0392b); padding: 8px 4px; border-radius: 15px; width: 100%; box-sizing: border-box; box-shadow: 0 10px 20px rgba(139, 69, 19, 0.3), inset 0 2px 5px rgba(255,255,255,0.5); border: 2px solid rgba(255, 255, 255, 0.4); }
        
        .evo-formula { display: grid; grid-template-columns: 24px 30px 28px; align-items: center; justify-items: center; justify-content: center; gap: 2px; width: 100%; padding: 4px 0; border-bottom: 1px dashed rgba(255,255,255,0.3); }
        .evo-formula:last-child { border-bottom: none; }
        
        .evo-small { width: 22px; height: 22px; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .evo-big { width: 28px; height: 28px; object-fit: contain; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3)); }
        .evo-math { font-size: 13px; font-weight: normal; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.4); font-family: 'Jua', sans-serif; }
        
        #canvas-wrapper { grid-column: 2; grid-row: 3; display: flex; width: 100%; margin-top: -65px; position: relative; z-index: 1; }
        canvas { width: 100%; height: auto; aspect-ratio: 360 / 600; background: transparent; border: none; outline: none; cursor: crosshair; touch-action: none; }

        .effect-text { position: absolute; top: 45%; left: 50%; width: 90%; text-align: center; transform: translate(-50%, -50%); font-weight: 900; color: #fff; font-family: 'Jua', sans-serif; pointer-events: none; opacity: 0; z-index: 100; line-height: 1.15; word-break: keep-all; }

        #good-effect { font-size: clamp(35px, 8vw, 45px); }
        .show-good { animation: goodGlowFade 2.0s ease-out forwards; }
        @keyframes goodGlowFade { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotate(-3deg); text-shadow: 0 0 20px #fff, 0 0 40px #00e676, 0 0 80px #1de9b6; } 40% { transform: translate(-50%, -50%) scale(1.0) rotate(2deg); } 70% { opacity: 1; transform: translate(-50%, -50%) scale(1.05) rotate(0deg); text-shadow: 0 0 10px #fff, 0 0 20px #00e676; } 100% { opacity: 0; transform: translate(-50%, -65%) scale(1.15); text-shadow: 0 0 5px #fff; } }

        #great-effect { font-size: clamp(40px, 9vw, 50px); }
        .show-great { animation: greatGlowFade 2.0s ease-out forwards; }
        @keyframes greatGlowFade { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.15) rotate(4deg); text-shadow: 0 0 20px #fff, 0 0 40px #e040fb, 0 0 80px #d500f9; } 40% { transform: translate(-50%, -50%) scale(1.0) rotate(-2deg); } 70% { opacity: 1; transform: translate(-50%, -50%) scale(1.05) rotate(0deg); text-shadow: 0 0 10px #fff, 0 0 20px #e040fb; } 100% { opacity: 0; transform: translate(-50%, -65%) scale(1.2); text-shadow: 0 0 5px #fff; } }

        #wow-effect { font-size: clamp(45px, 10vw, 55px); }
        .show-wow { animation: wowGlowFade 2.0s ease-out forwards; }
        @keyframes wowGlowFade { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2) rotate(-5deg); text-shadow: 0 0 20px #fff, 0 0 50px #ffea00, 0 0 90px #ff9100, 0 0 150px #ff5100; } 40% { transform: translate(-50%, -50%) scale(1.05) rotate(3deg); } 70% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotate(0deg); text-shadow: 0 0 10px #fff, 0 0 30px #ffea00, 0 0 50px #ff9100; } 100% { opacity: 0; transform: translate(-50%, -65%) scale(1.25); text-shadow: 0 0 5px #fff; } }

        #clear-effect { font-size: clamp(32px, 8vw, 42px); }
        .show-clear { animation: clearGlowFade 3.0s ease-out forwards; } 
        @keyframes clearGlowFade { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 15% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotate(2deg); text-shadow: 0 0 20px #fff, 0 0 50px #00e5ff, 0 0 90px #008cff, 0 0 150px #0051ff; } 30% { transform: translate(-50%, -50%) scale(1.0) rotate(-2deg); } 60% { opacity: 1; transform: translate(-50%, -50%) scale(1.05) rotate(0deg); text-shadow: 0 0 10px #fff, 0 0 30px #00e5ff, 0 0 60px #008cff; } 100% { opacity: 0; transform: translate(-50%, -70%) scale(1.15); text-shadow: 0 0 5px #fff; } }

        #button-container { 
            grid-column: 1 / -1; justify-self: center; 
            display: flex; gap: 8px; margin-top: 0px; position: relative; z-index: 10; 
            flex-wrap: wrap; justify-content: center;
        }
        
        .game-btn { 
            padding: 8px 12px; 
            border-radius: 20px; font-size: 14px; font-family: 'Jua', sans-serif; 
            cursor: pointer; box-shadow: 0 4px 6px rgba(139, 69, 19, 0.1); 
            transition: 0.1s; border: 2px solid; 
            display: flex; align-items: center; justify-content: center;
            box-sizing: border-box; line-height: 1; white-space: nowrap; 
        }
        .game-btn:active { transform: translateY(2px); box-shadow: 0 2px 3px rgba(139, 69, 19, 0.1); }
        
        #mute-btn { background: #fff; color: #d35400; border-color: #e1b12c; }
        #restart-btn { background: #d35400; color: #fff; border-color: #c0392b; }
        #home-btn { background: #fff; color: #8B4513; border-color: #8B4513; text-decoration: none; }

        .stamp { opacity: 0.2; filter: grayscale(100%); transition: all 0.3s ease; }
        .stamp.filled { opacity: 1; filter: grayscale(0%); animation: popStamp 0.4s ease-out forwards; }
        @keyframes popStamp { 0% { transform: scale(0.5); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        #earthquake-toast { transition: opacity 0.3s, transform 0.3s; z-index: 100; }
        #earthquake-toast.hidden { opacity: 0; transform: translateY(-10px); pointer-events: none; }

        /* ğŸ›’ í™©ê¸ˆ ìƒì  UI CSS */
        #shop-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: flex-start; padding-top: 60px; z-index: 9999; 
            opacity: 1; transition: opacity 0.3s ease;
        }
        #shop-modal.hidden { opacity: 0; pointer-events: none; }
        
        .shop-container {
            width: 320px; height: 550px; max-height: 85vh;
            background: linear-gradient(135deg, #fffaf0 0%, #ffe0b2 100%);
            border: 4px solid #DAA520; border-radius: 20px;
            display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 15px rgba(255,215,0,0.3);
            transform: translateY(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #shop-modal.hidden .shop-container { transform: translateY(30px); }

        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 2px dashed rgba(218,165,32,0.5); padding-bottom: 8px; }
        .shop-header h2 { margin: 0; color: #8B4513; font-family: 'Jua'; font-size: 22px; text-shadow: 1px 1px 0 #FFD700; display: flex; align-items: center; gap: 5px; }
        #close-shop-btn { background: #fff; border: 2px solid #DAA520; color: #8B4513; font-size: 14px; font-weight: bold; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .shop-wallet {
            background: #d35400; border: 2px solid #f1c40f; border-radius: 20px;
            padding: 8px 0; font-family: 'Jua'; font-size: 16px; color: #fff;
            margin-bottom: 15px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 2px 4px rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center; gap: 15px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .shop-tabs { display: flex; gap: 4px; margin-bottom: 15px; }
        .shop-tab {
            flex: 1; text-align: center; padding: 10px 0; font-family: 'Jua'; font-size: 15px;
            background: #fff5e6; color: #a0522d; border-radius: 12px 12px 0 0;
            border: 2px solid transparent; border-bottom: 3px solid #DAA520; 
            cursor: pointer; transition: 0.2s;
        }
        .shop-tab.active { 
            background: #FFD700; color: #8B4513; font-weight: bold; 
            border: 2px solid #DAA520; border-bottom: none; transform: translateY(-2px); 
        }
        
        .shop-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px; }
        .shop-content::-webkit-scrollbar { width: 6px; }
        .shop-content::-webkit-scrollbar-track { background: rgba(255,215,0,0.1); border-radius: 10px; }
        .shop-content::-webkit-scrollbar-thumb { background: #DAA520; border-radius: 10px; }

        .shop-item {
            background: #fff; border: 2px solid #FFD700; border-radius: 12px;
            padding: 10px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.1s;
        }
        .shop-item:active { transform: scale(0.98); }
        .shop-item-img-wrapper { width: 48px; height: 48px; background: #fff5e6; border-radius: 50%; border: 2px solid #ffe0b2; display: flex; justify-content: center; align-items: center; flex-shrink: 0; overflow: hidden; }
        .shop-item-img { width: 36px; height: 36px; object-fit: contain; }
        
        .filter-night { filter: brightness(0.6) sepia(0.8) hue-rotate(200deg) saturate(300%); }

        .shop-item-info { flex: 1; }
        .shop-item-name { font-family: 'Jua'; font-size: 15px; color: #8B4513; margin-bottom: 2px; line-height: 1.1; }
        .shop-item-desc { font-size: 11px; color: #666; line-height: 1.2; word-break: keep-all; }
        
        .shop-item-btn {
            padding: 6px 12px; border-radius: 15px; font-family: 'Jua'; font-size: 13px; cursor: pointer; border: 2px solid; white-space: nowrap; transition: 0.1s;
        }
        .btn-buy { background: #f57c00; color: #fff; border-color: #DAA520; }
        .btn-buy:active { background: #e65100; }
        .btn-equip { background: #4caf50; color: #fff; border-color: #388e3c; }
        .btn-equipped { background: #e0e0e0; color: #757575; border-color: #bdbdbd; cursor: default; }

        /* ğŸŒ™ [ì¶”ê°€] ì‹¬ì•¼ í¬ì¥ë§ˆì°¨ (í™˜ê²½ íƒ­) ì „ìš© CSS - ì¦‰ì‹œ ì „í™˜ ë° ëª¨ë°”ì¼ ìµœì í™”! */
        body.night-mode {
            /* ê¹Šê³  í‘¸ë¥¸ ë°¤í•˜ëŠ˜ ê°ì„± */
            background: linear-gradient(to bottom, #0f172a 0%, #1b2a47 40%, #2e4a62 80%, #0d1117 100%);
        }
        
        body.night-mode #game-title {
            /* ì œì•ˆ 2 ë°˜ì˜: í¬ì¥ë§ˆì°¨ ë°±ì—´ì „êµ¬ë¥¼ ëŠ˜ì–´ëœ¨ë¦° ë“¯í•œ í™”ë ¤í•œ ë„¤ì˜¨ íš¨ê³¼ */
            color: #ffdda1; 
            text-shadow: 2px 2px 0px #d35400, 0px 0px 10px #ffea00, 0px 0px 20px #ff9100, 0px 0px 30px #ff5100;
        }
        
        body.night-mode .side-title { color: #ffdda1; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        
        body.night-mode #next-snack-bubble { 
            /* ë‹¬ë¹›ì„ ë°›ì€ ë“¯í•œ ì€ì€í•œ í‘¸ë¥¸ë¹› ìœ ë¦¬ ì§ˆê° */
            background: radial-gradient(circle at 30% 30%, rgba(200,220,255,0.2) 0%, rgba(50,70,100,0.4) 100%);
            border-color: rgba(200, 220, 255, 0.4);
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.6), inset 3px 3px 10px rgba(200,220,255,0.2), 0 8px 15px rgba(0,0,0,0.7); 
        }

        body.night-mode .stat-box {
            /* ì œì•ˆ 1 ë°˜ì˜: ë°¤ì— ë§ì¶° í†¤ë‹¤ìš´ & í…Œë‘ë¦¬ë¥¼ ì˜…ì€ íšŒìƒ‰ìœ¼ë¡œ ê°•ì¡° */
            background: rgba(15, 23, 42, 0.85); 
            border-color: #a0aec0; /* ì˜…ì€ íšŒìƒ‰/í‘¸ë¥¸ë¹› í…Œë‘ë¦¬ */
            color: #e2e8f0;
        }
        
        /* ì œì•ˆ 1 ë°˜ì˜: ì¹˜í‚¨ ì´ëª¨ì§€(ğŸ—)ë„ ì˜…ì€ íšŒìƒ‰ìœ¼ë¡œ í•„í„° ì²˜ë¦¬ */
        body.night-mode .stamp { filter: grayscale(100%) brightness(1.5); opacity: 0.4; }
        body.night-mode .stamp.filled { filter: grayscale(0%) brightness(1); opacity: 1; }

        body.night-mode .stat-box.high {
            /* ëˆ„ì  ì¹˜í‚¨ ì°½: í¬ì¥ë§ˆì°¨ íŠ¹ìœ ì˜ ë¶‰ì€ ì²œ ìƒ‰ìƒìœ¼ë¡œ í¬ì¸íŠ¸! */
            background: rgba(180, 50, 20, 0.9); border-color: #ffdda1; color: #fff;
        }

        body.night-mode #evolution-chain {
            /* ì§„í™” ê³µì‹ íŒ¨ë„: ì–´ë‘ìš´ ë°¤í•˜ëŠ˜ í†¤ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë™í™”ë¨ */
            background: linear-gradient(to bottom, rgba(30,40,60,0.9), rgba(15,20,30,0.9)); 
            border-color: #a0aec0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255,255,255,0.1);
        }
        
        body.night-mode .game-btn {
            background: rgba(30, 40, 60, 0.9); color: #e2e8f0; border-color: #a0aec0;
        }
    </style>
</head>
<body>
    
    <div id="app-grid">
        <h1 id="game-title">K-SNACK MERGE!</h1>
        
       <div id="stats-board">
            <div class="stat-box high">
                <span style="white-space: nowrap;">ëˆ„ì  ì¹˜í‚¨: <span id="total-chicken" style="color: #fffea0;">0</span>ë§ˆë¦¬</span>
            </div>
            
            <div class="stat-box" style="gap: 5px; background: rgba(0,0,0,0.6);">
                <span style="color: #f1c40f; white-space: nowrap;">í”ë“¤ê¸° ì°¬ìŠ¤:</span>
                <div style="display: flex; gap: 2px; font-size: 12px; margin-top: -1px;">
                    <span class="stamp" id="stamp-1">ğŸ—</span>
                    <span class="stamp" id="stamp-2">ğŸ—</span>
                    <span class="stamp" id="stamp-3">ğŸ—</span>
                </div>
            </div>

            <div class="stat-box" id="shop-btn">
                ğŸ›’ ìƒì 
            </div>

            <div id="earthquake-toast" class="hidden stat-box" style="background: #c0392b; border-color: #f1c40f; position: absolute; top: 40px; z-index: 100; white-space: nowrap;">
                ğŸš¨ ì—°ì† 3ë§ˆë¦¬ ë‹¬ì„±! ìƒìê°€ ìš”ë™ì¹©ë‹ˆë‹¤!
            </div>
        </div>

        <div id="side-panel">
            <div id="next-snack-container">
                <div class="side-title">ë‹¤ìŒ ê°„ì‹</div>
                <div id="next-snack-bubble"><img id="next-snack-img" src=""></div>
            </div>
            
            <div id="evolution-container">
                <div class="side-title">ì§„í™” ê³µì‹</div>
                <div id="evolution-chain"></div>
            </div>
        </div>
        
        <div id="canvas-wrapper">
            <div id="good-effect" class="effect-text">GOOD!</div>
            <div id="great-effect" class="effect-text">GREAT!</div>
            <div id="wow-effect" class="effect-text">WOW!</div>
            <div id="clear-effect" class="effect-text">Chicken Clear!<br>Go On!</div>
            
            <canvas id="gameCanvas" width="360" height="600"></canvas>
        </div>

        <div id="button-container">
            <button id="restart-btn" class="game-btn">ë°•ìŠ¤ ë¹„ìš°ê¸°</button>
            <button id="mute-btn" class="game-btn">ğŸ”Š ì†Œë¦¬ ì¼œì§</button>
            <button id="home-btn" class="game-btn" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ ì´ë™</button>
        </div>
    </div>

    <div id="shop-modal" class="hidden">
        <div class="shop-container">
            <div class="shop-header">
                <h2>ğŸ›’ K-ê°„ì‹ ìƒì </h2>
                <button id="close-shop-btn">X</button>
            </div>
            <div class="shop-wallet"><span>ğŸ’° ê¸ˆê³ :</span> <span>ğŸ— <span id="shop-wallet-count">0</span>ë§ˆë¦¬</span></div>
            <div class="shop-tabs">
                <div class="shop-tab active" data-tab="growth">ì„±ì¥</div>
                <div class="shop-tab" data-tab="collection">ìˆ˜ì§‘</div>
                <div class="shop-tab" data-tab="environment">í™˜ê²½</div>
            </div>
            <div class="shop-content" id="shop-content">
                </div>
        </div>
    </div>

    <script>
        const SNACKS = [
            { name: "ì•Œì‚¬íƒ•", radius: 22, img: "candy.png" },        
            { name: "í˜¸ë‘ê³¼ì", radius: 30, img: "walnut.png" },      
            { name: "ë¸ë¦¬ë§Œì¥¬", radius: 38, img: "manjoo.png" },      
            { name: "ì™•ë§Œë‘", radius: 46, img: "mandu.png" },         
            { name: "ëš±ë¶•ì–´ë¹µ", radius: 52, img: "fish.png" },         
            { name: "ì”¨ì•—í˜¸ë–¡", radius: 60, img: "hotteok.png" },      
            { name: "ëŒ€ì™•ì†œì‚¬íƒ•", radius: 72, img: "cottoncandy.png" }, 
            { name: "í™©ê¸ˆì¹˜í‚¨", radius: 95, img: "chicken.png" }       
        ];

        const loadedImages = {};
        const evoContainer = document.getElementById('evolution-chain');
        
        SNACKS.forEach((snack, index) => {
            const img = new Image(); img.src = snack.img; loadedImages[index] = img;
            if (index < SNACKS.length - 1) {
                const formulaDiv = document.createElement('div');
                formulaDiv.className = 'evo-formula';
                formulaDiv.innerHTML = `<img class="evo-small" src="${snack.img}"><span class="evo-math">x 2 =</span><img class="evo-big" src="${SNACKS[index + 1].img}">`;
                evoContainer.appendChild(formulaDiv);
            }
        });

        const clearFormulaDiv = document.createElement('div');
        clearFormulaDiv.className = 'evo-formula';
        clearFormulaDiv.innerHTML = `<img class="evo-small" src="${SNACKS[7].img}"><span class="evo-math">x 2 =</span><span class="evo-math" style="color:#f1c40f; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">Clear</span>`;
        evoContainer.appendChild(clearFormulaDiv);

        const Engine = Matter.Engine, Render = Matter.Render, World = Matter.World,
              Bodies = Matter.Bodies, Events = Matter.Events, Runner = Matter.Runner, Composite = Matter.Composite;

        const engine = Engine.create(); const world = engine.world;
        engine.gravity.y = 1.2; 
        
        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');

        let totalChickens = parseInt(localStorage.getItem('kSnackTotalChickens') || 0, 10);
        document.getElementById('total-chicken').innerText = totalChickens;

        let shopData = {
            owned: JSON.parse(localStorage.getItem('kSnackOwned')) || [],
            equipped: JSON.parse(localStorage.getItem('kSnackEquipped')) || { growth: [], collection: [], environment: null }
        };

        ['growth', 'collection'].forEach(cat => {
            if (shopData.equipped[cat] && !Array.isArray(shopData.equipped[cat])) {
                shopData.equipped[cat] = [shopData.equipped[cat]];
            } else if (!shopData.equipped[cat]) {
                shopData.equipped[cat] = [];
            }
        });
        
        let currentShopTab = 'growth';
        let isShopOpen = false;

        // ğŸ’¡ [ì™„ì „íŒ] ìŠ¤í‚¨(ì´ë¯¸ì§€) ë° í™˜ê²½(ë°°ê²½)ì„ ì¦‰ì‹œ êµì²´í•˜ëŠ” í•¨ìˆ˜!
        function applySkins() {
            const collection = Array.isArray(shopData.equipped.collection) ? shopData.equipped.collection : [];

            SNACKS[3].img = "mandu.png";
            SNACKS[4].img = "fish.png";

            if (collection.includes('rainbow')) SNACKS[3].img = "rainbow_mandu.png"; 
            if (collection.includes('blackfish')) SNACKS[4].img = "black_fish.png";  

            // ğŸ’¡ [ë²„ê·¸ í•´ê²°] ê¹ê¹í•œ íŒŒì¼ëª… ê²€ì‚¬
            SNACKS.forEach((snack, index) => {
                const currentFileName = loadedImages[index].src.split('/').pop();
                if (currentFileName !== snack.img) {
                    loadedImages[index].src = snack.img; 
                }
            });

            // ğŸ’¡ [ìµœì í™” ì™„ë£Œ] ì§„í™” ê³µì‹ UI ì´ˆê³ ì† êµì²´
            const evoFormulas = document.getElementById('evolution-chain').children;
            if (evoFormulas.length > 0) { 
                SNACKS.forEach((snack, index) => {
                    if (index < SNACKS.length - 1) {
                        evoFormulas[index].querySelector('.evo-small').src = snack.img;
                        evoFormulas[index].querySelector('.evo-big').src = SNACKS[index + 1].img;
                    } else if (index === 7) { 
                        evoFormulas[index].querySelector('.evo-small').src = snack.img;
                    }
                });
            }

            const nextSnackImgEl = document.getElementById('next-snack-img');
            if (nextSnackImgEl && typeof upcomingSnackIndex !== 'undefined') {
                nextSnackImgEl.src = SNACKS[upcomingSnackIndex].img;
            }

            // ğŸŒ™ [ì¶”ê°€] í™˜ê²½(ë°°ê²½) ìŠ¤ìœ„ì¹˜!
            const environment = shopData.equipped.environment;
            if (environment === 'night') {
                document.body.classList.add('night-mode');
            } else {
                document.body.classList.remove('night-mode');
            }
        }

        let isDropping = false; let previewX = canvas.width / 2; let frameCount = 0;
        
        function getRandomSnackIndex() {
            const growth = Array.isArray(shopData.equipped.growth) ? shopData.equipped.growth : [];
            const rand = Math.random(); 
            
            const hasBung = growth.includes('bungeoppang');
            const hasMandu = growth.includes('wangmandu');

            if (hasBung && hasMandu) {
                if (rand < 0.25) return 0;
                if (rand < 0.50) return 1;
                if (rand < 0.75) return 2;
                if (rand < 0.90) return 3; 
                return 4;                  
            } else if (hasBung && !hasMandu) {
                if (rand < 0.30) return 0;
                if (rand < 0.60) return 1;
                if (rand < 0.90) return 2;
                return 4; 
            } else if (!hasBung && hasMandu) {
                if (rand < 0.2833) return 0;
                if (rand < 0.5666) return 1;
                if (rand < 0.85) return 2;  
                return 3;                  
            } else {
                return Math.floor(rand * 3); 
            }
        }

        // ğŸ’¡ [í•´ê²°!] 1. ë²ˆí˜¸ë¥¼ ë¨¼ì € ë½‘ê³  2. ìŠ¤í‚¨ì„ ì…í™ë‹ˆë‹¤ 
        let currentDroppingIndex = getRandomSnackIndex();
        let upcomingSnackIndex = getRandomSnackIndex();
        applySkins(); 

        const fx1 = 20, fx2 = 340, fy_top = 180, fy_bot = 580; 
        const bx1 = 60, bx2 = 300, by_top = 130, by_bot = 560; 
        const dropY = 110; 

        const wallOptions = { isStatic: true, render: { fillStyle: 'transparent' }, friction: 0.05, restitution: 0.2, label: 'Wall' };
        World.add(world, [
            Bodies.rectangle(10, 380, 20, 400, wallOptions),
            Bodies.rectangle(350, 380, 20, 400, wallOptions),
            Bodies.rectangle(180, 590, 360, 20, wallOptions)
        ]);

        let audioCtx = null; let isMuted = false;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }

        let feverCount = 0; 
        function addChickenFever() {
            feverCount++;
            if (feverCount <= 3) { document.getElementById('stamp-' + feverCount).classList.add('filled'); }
            if (feverCount === 3) { triggerEarthquake(); }
        }

        const SHOP_ITEMS = {
            growth: [
                { id: 'wangmandu', name: 'ì™•ë§Œë‘ ë“œë¡­', price: 15, desc: 'ì™•ë§Œë‘ë„<br>ë“œë¡­í•  ìˆ˜ ìˆì–´ìš”', img: 'mandu.png' },
                { id: 'bungeoppang', name: 'ë¶•ì–´ë¹µ ë“œë¡­', price: 20, desc: 'ë¶•ì–´ë¹µë„<br>ë“œë¡­í•  ìˆ˜ ìˆì–´ìš”', img: 'fish.png' }
            ],
            collection: [
                { id: 'blackfish', name: 'ê¹Œë§Œ ë¶•ì–´ë¹µ', price: 10, desc: 'ì‚´ì§ íƒ”ì§€ë§Œ<br>ë°”ì‚­í•œ ìŠ¤í‚¨', img: 'black_fish.png' },
                { id: 'rainbow', name: 'ë¬´ì§€ê°œ ë§Œë‘', price: 8, desc: 'ì˜ë¡±í•œ ë¹›ê¹”ì˜<br>ë¬´ì§€ê°œ ìŠ¤í‚¨', img: 'rainbow_mandu.png' } 
            ],
            environment: [
                { id: 'night', name: 'ì‹¬ì•¼ í¬ì¥ë§ˆì°¨', price: 10, desc: 'í¬ì¥ë§ˆì°¨ ê°ì„±ì˜<br>íŠ¹ë³„í•œ ë°°ê²½', img: 'tent.png' }
            ]
        };

        function renderShopItems() {
            document.getElementById('shop-wallet-count').innerText = totalChickens;
            const container = document.getElementById('shop-content');
            container.innerHTML = '';
            
            SHOP_ITEMS[currentShopTab].forEach(item => {
                const isOwned = shopData.owned.includes(item.id);
                const isEquipped = Array.isArray(shopData.equipped[currentShopTab]) 
                    ? shopData.equipped[currentShopTab].includes(item.id) 
                    : shopData.equipped[currentShopTab] === item.id;
                
                let btnHtml = '';
                if (isEquipped) {
                    btnHtml = `<button class="shop-item-btn btn-equipped" style="cursor: pointer;" onclick="unequipItem('${currentShopTab}', '${item.id}')">ì¥ì°© í•´ì œ</button>`;
                } else if (isOwned) {
                    btnHtml = `<button class="shop-item-btn btn-equip" onclick="equipItem('${currentShopTab}', '${item.id}')">ì¥ì°©í•˜ê¸°</button>`;
                } else {
                    btnHtml = `<button class="shop-item-btn btn-buy" onclick="buyItem('${item.id}', '${currentShopTab}', ${item.price})">ğŸ— ${item.price} êµ¬ë§¤</button>`;
                } 

                container.innerHTML += `
                    <div class="shop-item">
                        <div class="shop-item-img-wrapper">
                            <img src="${item.img}" class="shop-item-img">
                        </div>
                        <div class="shop-item-info">
                            <div class="shop-item-name">${item.name}</div>
                            <div class="shop-item-desc">${item.desc}</div>
                        </div>
                        ${btnHtml}
                    </div>
                `;
            });
        }

        window.buyItem = function(id, category, price) {
            initAudio();
            if (totalChickens >= price) {
                totalChickens -= price;
                document.getElementById('total-chicken').innerText = totalChickens;
                localStorage.setItem('kSnackTotalChickens', totalChickens);
                
                shopData.owned.push(id);
                localStorage.setItem('kSnackOwned', JSON.stringify(shopData.owned));
                
                playGoodSound(); 
                renderShopItems();
            } else {
                alert('ê¸ˆê³ ì— ì¹˜í‚¨ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ğŸ—');
            }
        };

        window.equipItem = function(category, id) {
            initAudio();
            if (category === 'growth' || category === 'collection') {
                if (!Array.isArray(shopData.equipped[category])) shopData.equipped[category] = [];
                if (!shopData.equipped[category].includes(id)) shopData.equipped[category].push(id);
            } else {
                shopData.equipped[category] = id;
            }
            
            localStorage.setItem('kSnackEquipped', JSON.stringify(shopData.equipped));
            playTone(300, 'sine', audioCtx.currentTime, 0.1, 0.1);
            applySkins(); 
            renderShopItems();
        };

        window.unequipItem = function(category, id) {
            initAudio();
            if (category === 'growth' || category === 'collection') {
                if (Array.isArray(shopData.equipped[category])) {
                    shopData.equipped[category] = shopData.equipped[category].filter(itemId => itemId !== id);
                }
            } else {
                shopData.equipped[category] = null;
            }
            
            localStorage.setItem('kSnackEquipped', JSON.stringify(shopData.equipped));
            playTone(300, 'sine', audioCtx.currentTime, 0.1, 0.1); 
            applySkins();
            renderShopItems();
        };        

        document.querySelectorAll('.shop-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentShopTab = e.target.getAttribute('data-tab');
                renderShopItems();
            });
        });

        let engineRunner = Runner.create(); 

        document.getElementById('shop-btn').addEventListener('click', () => {
            initAudio();
            isShopOpen = true; 
            Runner.stop(engineRunner); 
            document.getElementById('shop-modal').classList.remove('hidden');
            renderShopItems();
        });

        document.getElementById('close-shop-btn').addEventListener('click', () => {
            isShopOpen = false;
            document.getElementById('shop-modal').classList.add('hidden');

            const growth = Array.isArray(shopData.equipped.growth) ? shopData.equipped.growth : [];
            const hasBung = growth.includes('bungeoppang');
            const hasMandu = growth.includes('wangmandu');

            let isValidCurrent = true;
            if (currentDroppingIndex === 4 && !hasBung) isValidCurrent = false; 
            if (currentDroppingIndex === 3 && !hasMandu) isValidCurrent = false; 

            let isValidUpcoming = true;
            if (upcomingSnackIndex === 4 && !hasBung) isValidUpcoming = false;
            if (upcomingSnackIndex === 3 && !hasMandu) isValidUpcoming = false;

            if (!isValidCurrent) currentDroppingIndex = getRandomSnackIndex();
            if (!isValidUpcoming) upcomingSnackIndex = getRandomSnackIndex();

            document.getElementById('next-snack-img').src = SNACKS[upcomingSnackIndex].img;
            Runner.start(engineRunner, engine); 
        });

        // ğŸŒ‹ ëŒ€ì§€ì§„ ë¡œì§
        function triggerEarthquake() {
            const toast = document.getElementById('earthquake-toast');
            toast.classList.remove('hidden');

            const safetyOptions = { isStatic: true, friction: 0, restitution: 0, label: 'SafetyNet' };
            const safetyNet = [
                Bodies.rectangle(10, -200, 20, 1000, safetyOptions),
                Bodies.rectangle(350, -200, 20, 1000, safetyOptions),
                Bodies.rectangle(180, -800, 400, 50, safetyOptions)
            ];
            World.add(world, safetyNet); 

            setTimeout(() => {
                playRumbleSound(2.5);
                const shakeInterval = setInterval(() => {
                    const allBodies = Composite.allBodies(world);
                    allBodies.forEach(body => {
                        if (body.label !== 'Wall' && body.label !== 'SafetyNet') {
                            Matter.Body.setVelocity(body, { x: (Math.random() - 0.5) * 5, y: (Math.random() - 0.5) * 5 - 1 });
                        }
                    });
                }, 100); 

                setTimeout(() => {
                    clearInterval(shakeInterval);
                    toast.classList.add('hidden');
                    playLaunchSound();
                    setTimeout(() => playFallSound(), 1350);

                    const allBodies = Composite.allBodies(world);
                    allBodies.forEach(body => {
                        if (body.label !== 'Wall' && body.label !== 'SafetyNet') {
                            Matter.Body.setPosition(body, { x: body.position.x, y: body.position.y - 10 });
                            const level = parseInt(body.label); 
                            const popPower = 18 + ((7 - level) * 2.5) + (Math.random() * 4); 
                            
                            Matter.Body.setVelocity(body, { x: (Math.random() - 0.5) * 12, y: -popPower });
                            Matter.Body.setAngularVelocity(body, (Math.random() - 0.5) * 0.6);
                            body.frictionAir = 0.025 - (level * 0.003);
                        }
                    });

                    setTimeout(() => {
                        feverCount = 0;
                        document.getElementById('stamp-1').classList.remove('filled');
                        document.getElementById('stamp-2').classList.remove('filled');
                        document.getElementById('stamp-3').classList.remove('filled');

                        const currentBodies = Composite.allBodies(world);
                        currentBodies.forEach(body => {
                            if (body.label !== 'Wall' && body.label !== 'SafetyNet') {
                                body.frictionAir = 0.001; 
                            }
                        });
                        World.remove(world, safetyNet);
                    }, 4000); 
                }, 2500); 
            }, 1500); 
        }

        // ğŸµ ì‚¬ìš´ë“œ ëª¨ë“ˆ
        function playTone(freq, type, startTime, duration, vol = 0.2) { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.value = freq; gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(vol, startTime + 0.02); gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration); osc.start(startTime); osc.stop(startTime + duration); }
        function playSnap(startTime, freq = 300) { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(freq * 1.5, startTime); osc.frequency.exponentialRampToValueAtTime(freq / 2, startTime + 0.03); gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.5, startTime + 0.002); gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.04); osc.start(startTime); osc.stop(startTime + 0.04); }
        function playDropSound() { if (isMuted || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
        function playMergeSound(level) { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33]; const baseFreq = scale[Math.min(level, scale.length - 1)]; playSnap(now, baseFreq); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(baseFreq, now); osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, now + 0.15); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.2, now + 0.02); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
        function playGoodSound() { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; const notes = [261.63, 329.63, 392.00]; notes.forEach((freq, i) => { const t = now + (i * 0.06); playSnap(t, freq); playTone(freq, 'sine', t, 0.6, 0.25); }); }
        function playGreatSound() { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; const notes = [261.63, 329.63, 392.00, 523.25]; notes.forEach((freq, i) => { const t = now + (i * 0.08); const mainOsc = audioCtx.createOscillator(); const mainGain = audioCtx.createGain(); mainOsc.type = 'sine'; mainOsc.connect(mainGain); mainGain.connect(audioCtx.destination); mainOsc.frequency.setValueAtTime(freq, t); mainGain.gain.setValueAtTime(0, t); mainGain.gain.linearRampToValueAtTime(0.2, t + 0.02); mainGain.gain.exponentialRampToValueAtTime(0.01, t + 0.8); mainOsc.start(t); mainOsc.stop(t + 0.8); }); }
        function playWowSound() { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; const notes = [329.63, 392.00, 523.25, 587.33, 783.99]; notes.forEach((freq, i) => { const t = now + (i * 0.06); const mainOsc = audioCtx.createOscillator(); const mainGain = audioCtx.createGain(); mainOsc.type = 'triangle'; mainOsc.connect(mainGain); mainGain.connect(audioCtx.destination); mainOsc.frequency.setValueAtTime(freq, t); mainGain.gain.setValueAtTime(0, t); mainGain.gain.linearRampToValueAtTime(0.25, t + 0.02); mainGain.gain.exponentialRampToValueAtTime(0.01, t + 1.2); mainOsc.start(t); mainOsc.stop(t + 1.2); }); }
        function playClearSound() { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; for (let i = 0; i < 30; i++) { const popTime = now + (Math.random() * 1.45); const popOsc = audioCtx.createOscillator(); const popGain = audioCtx.createGain(); popOsc.type = 'sine'; popOsc.connect(popGain); popGain.connect(audioCtx.destination); const startFreq = 400 + Math.random() * 300; popOsc.frequency.setValueAtTime(startFreq, popTime); popOsc.frequency.exponentialRampToValueAtTime(startFreq * 0.5, popTime + 0.05); popGain.gain.setValueAtTime(0, popTime); popGain.gain.linearRampToValueAtTime(0.15 + Math.random() * 0.1, popTime + 0.01); popGain.gain.exponentialRampToValueAtTime(0.01, popTime + 0.06); popOsc.start(popTime); popOsc.stop(popTime + 0.06); const snapOsc = audioCtx.createOscillator(); const snapGain = audioCtx.createGain(); snapOsc.type = 'triangle'; snapOsc.connect(snapGain); snapGain.connect(audioCtx.destination); snapOsc.frequency.setValueAtTime(800 + Math.random() * 500, popTime); snapGain.gain.setValueAtTime(0.05, popTime); snapGain.gain.exponentialRampToValueAtTime(0.001, popTime + 0.02); snapOsc.start(popTime); snapOsc.stop(popTime + 0.02); } const clearNotes = [261.63, 392.00, 523.25, 659.25, 783.99, 1046.50]; clearNotes.forEach((freq, i) => { const t = now + (i * 0.05); const chordOsc = audioCtx.createOscillator(); const chordGain = audioCtx.createGain(); chordOsc.type = 'triangle'; chordOsc.connect(chordGain); chordGain.connect(audioCtx.destination); chordOsc.frequency.setValueAtTime(freq, t); chordGain.gain.setValueAtTime(0, t); chordGain.gain.linearRampToValueAtTime(0.3, t + 0.02); chordGain.gain.exponentialRampToValueAtTime(0.01, t + 1.5); chordOsc.start(t); chordOsc.stop(t + 1.5); }); }
        function playRumbleSound(duration) { if (isMuted || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sawtooth'; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(40, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + duration / 2); osc.frequency.linearRampToValueAtTime(40, audioCtx.currentTime + duration); gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.04, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.04, audioCtx.currentTime + duration - 0.2); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration); osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + duration); }
        function playLaunchSound() { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; const boomOsc = audioCtx.createOscillator(); const boomGain = audioCtx.createGain(); boomOsc.type = 'triangle'; boomOsc.connect(boomGain); boomGain.connect(audioCtx.destination); boomOsc.frequency.setValueAtTime(300, now); boomOsc.frequency.exponentialRampToValueAtTime(30, now + 0.2); boomGain.gain.setValueAtTime(0, now); boomGain.gain.linearRampToValueAtTime(0.12, now + 0.02); boomGain.gain.exponentialRampToValueAtTime(0.001, now + 0.6); boomOsc.start(now); boomOsc.stop(now + 0.6); const snapOsc = audioCtx.createOscillator(); const snapGain = audioCtx.createGain(); snapOsc.type = 'sawtooth'; snapOsc.connect(snapGain); snapGain.connect(audioCtx.destination); snapOsc.frequency.setValueAtTime(600, now); snapOsc.frequency.exponentialRampToValueAtTime(50, now + 0.15); snapGain.gain.setValueAtTime(0, now); snapGain.gain.linearRampToValueAtTime(0.08, now + 0.01); snapGain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); snapOsc.start(now); snapOsc.stop(now + 0.3); }
        function playFallSound() { if (isMuted || !audioCtx) return; const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(30, now + 0.15); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.10, now + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); }

        document.getElementById('mute-btn').addEventListener('click', (e) => { isMuted = !isMuted; e.target.innerText = isMuted ? 'ğŸ”‡ ì†Œë¦¬ êº¼ì§' : 'ğŸ”Š ì†Œë¦¬ ì¼œì§'; });
        
        document.getElementById('restart-btn').addEventListener('click', () => {
            const allBodies = Composite.allBodies(world);
            allBodies.forEach(body => { if (body.label !== 'Wall') World.remove(world, body); });
            
            currentDroppingIndex = getRandomSnackIndex(); 
            upcomingSnackIndex = getRandomSnackIndex(); 
            document.getElementById('next-snack-img').src = SNACKS[upcomingSnackIndex].img;
            isDropping = false;
        });

        function createSnack(x, y, level) {
            const baseDensity = 0.001;
            const snackDensity = baseDensity * Math.pow(1.2, level);
            const body = Bodies.circle(x, y, SNACKS[level].radius, {
                restitution: 0.3, friction: 0.005, density: snackDensity, label: level.toString()
            });
            World.add(world, body); return body;
        }

        function triggerEffect(id, className) {
            const el = document.getElementById(id);
            el.classList.remove(className);
            void el.offsetWidth; 
            el.classList.add(className);
        }

        Events.on(engine, 'collisionStart', (event) => {
            const pairs = event.pairs;
            for (let i = 0; i < pairs.length; i++) {
                const bodyA = pairs[i].bodyA; const bodyB = pairs[i].bodyB;
                if (bodyA.isMerging || bodyB.isMerging) continue;

                if (bodyA.label === bodyB.label && bodyA.label !== 'Wall') {
                    bodyA.isMerging = true; bodyB.isMerging = true;
                    let level = parseInt(bodyA.label);
                    const newX = (bodyA.position.x + bodyB.position.x) / 2;
                    const newY = (bodyA.position.y + bodyB.position.y) / 2;

                    if (level < SNACKS.length - 1) {
                        World.remove(world, bodyA); World.remove(world, bodyB);
                        const nextLevel = level + 1;
                        const newSnack = createSnack(newX, newY, nextLevel); 
                        Matter.Body.setVelocity(newSnack, { x: (Math.random() - 0.5) * 2, y: -4 });

                        if (nextLevel === 5) { playGoodSound(); triggerEffect('good-effect', 'show-good'); } 
                        else if (nextLevel === 6) { playGreatSound(); triggerEffect('great-effect', 'show-great'); } 
                        else if (nextLevel === 7) { 
                            playWowSound(); triggerEffect('wow-effect', 'show-wow'); 
                            totalChickens++; 
                            localStorage.setItem('kSnackTotalChickens', totalChickens); 
                            document.getElementById('total-chicken').innerText = totalChickens;
                            addChickenFever();
                        } else { playMergeSound(nextLevel); }
                    } 
                    else if (level === 7) { 
                        World.remove(world, bodyA); World.remove(world, bodyB); 
                        playClearSound(); triggerEffect('clear-effect', 'show-clear'); 
                    }
                }
            }
        });

        // ğŸ’¡ [ìµœì í™” ì™„ë£Œ] ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜ - ì¦‰ì‹œ ì „í™˜! ì—°ì‚°ëŸ‰ í­í’ ê°ì†Œ!
        function renderLoop() {
            if (!isShopOpen) {
                ctx.clearRect(0, 0, canvas.width, canvas.height); frameCount++;
                
                // ğŸ¨ ìº”ë²„ìŠ¤ ê·¸ë¼ë°ì´ì…˜ ê·¸ë¦¬ê¸° 
                const gradientTop = ctx.createLinearGradient(0, fy_top, 0, by_top);
                gradientTop.addColorStop(0, "rgba(255, 255, 255, 0.45)"); gradientTop.addColorStop(1, "rgba(255, 255, 255, 0)");
                ctx.fillStyle = gradientTop; ctx.fillRect(bx1, by_top, bx2 - bx1, fy_top - by_top);

                const sideGradient = ctx.createLinearGradient(fx1, fy_top, bx1, by_top); 
                sideGradient.addColorStop(0, "rgba(255, 255, 255, 0.6)"); sideGradient.addColorStop(1, "rgba(200, 180, 160, 0.2)"); 
                ctx.fillStyle = sideGradient;
                ctx.beginPath(); ctx.moveTo(fx1, fy_top); ctx.lineTo(bx1, by_top); ctx.lineTo(bx1, by_bot); ctx.lineTo(fx1, fy_bot); ctx.fill(); 
                
                const sideGradientRight = ctx.createLinearGradient(fx2, fy_top, bx2, by_top); 
                sideGradientRight.addColorStop(0, "rgba(255, 255, 255, 0.6)"); sideGradientRight.addColorStop(1, "rgba(200, 180, 160, 0.2)"); 
                ctx.fillStyle = sideGradientRight;
                ctx.beginPath(); ctx.moveTo(fx2, fy_top); ctx.lineTo(bx2, by_top); ctx.lineTo(bx2, by_bot); ctx.lineTo(fx2, fy_bot); ctx.fill(); 
                
                const bottomGradient = ctx.createRadialGradient(canvas.width/2, fy_bot, 50, canvas.width/2, fy_bot, 200); 
                bottomGradient.addColorStop(0, "rgba(100, 80, 60, 0.4)"); bottomGradient.addColorStop(1, "rgba(160, 140, 120, 0.1)"); 
                ctx.fillStyle = bottomGradient;
                ctx.beginPath(); ctx.moveTo(fx1, fy_bot); ctx.lineTo(bx1, by_bot); ctx.lineTo(bx2, by_bot); ctx.lineTo(fx2, fy_bot); ctx.fill();

                // ğŸŒ™ [ì œì•ˆ 3 ë°˜ì˜] 0ì´ˆ ì¦‰ì‹œ ì „í™˜! CSSì—ì„œ í´ë˜ìŠ¤ë§Œ í™•ì¸í•´ì„œ ìƒ‰ìƒ ë°”ë¡œ ì ìš©
                const isNight = document.body.classList.contains('night-mode');
                
                // ë‚®: ì£¼í™©ìƒ‰, ë°¤: í¬ì¥ë§ˆì°¨ ë¶‰ì€ìƒ‰
                const innerColor = isNight ? "rgba(220, 40, 40, 0.6)" : "rgba(255, 177, 66, 0.6)";
                const outerColor = isNight ? "rgb(220, 40, 40)" : "rgb(255, 177, 66)";

                // ğŸ¨ ì•ˆìª½ í…Œë‘ë¦¬ ê·¸ë¦¬ê¸°
                ctx.strokeStyle = innerColor; 
                ctx.lineWidth = 2; ctx.lineJoin = "round"; 
                ctx.strokeRect(bx1, by_top, bx2 - bx1, by_bot - by_top); 
                ctx.beginPath(); ctx.moveTo(fx1, fy_top); ctx.lineTo(bx1, by_top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(fx2, fy_top); ctx.lineTo(bx2, by_top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(fx1, fy_bot); ctx.lineTo(bx1, by_bot); ctx.stroke(); ctx.beginPath(); ctx.moveTo(fx2, fy_bot); ctx.lineTo(bx2, by_bot); ctx.stroke();
                
                // ğŸ¨ ê²Œì„ ì˜¤ë²„ ë¼ì¸ (ìƒë‹¨ í…Œë‘ë¦¬)
                ctx.strokeStyle = outerColor; 
                ctx.lineWidth = 5; 
                ctx.beginPath(); ctx.moveTo(fx1, fy_top); ctx.lineTo(fx2, fy_top); ctx.lineTo(bx2, by_top); ctx.lineTo(bx1, by_top); ctx.closePath(); ctx.stroke();

                if (!isDropping) {
                    const r = SNACKS[currentDroppingIndex].radius; const safeX = Math.max(r + 20, Math.min(previewX, canvas.width - r - 20));
                    
                    ctx.beginPath(); ctx.setLineDash([6, 5]); ctx.moveTo(safeX, dropY + r); ctx.lineTo(safeX, fy_bot);
                    ctx.strokeStyle = 'rgba(255, 120, 0, 0.9)'; ctx.lineWidth = 2.5; ctx.stroke(); ctx.setLineDash([]); 
                    
                    ctx.globalAlpha = 0.8; let bob = Math.sin(frameCount * 0.1) * 3; const img = loadedImages[currentDroppingIndex]; if (img && img.complete) { ctx.drawImage(img, safeX - r, dropY - r + bob, r * 2, r * 2); } ctx.globalAlpha = 1.0;
                }

                const bodies = Matter.Composite.allBodies(world);
                bodies.forEach(body => {
                    if (body.label !== 'Wall' && body.label !== 'SafetyNet') { 
                        const level = parseInt(body.label); const img = loadedImages[level]; const r = SNACKS[level].radius; const visualR = r * 1.35; 
                        ctx.save(); 
                        
                        if (body.position.y > fy_top && body.position.x > fx1 && body.position.x < fx2) {
                            ctx.beginPath();
                            ctx.rect(fx1, 0, fx2 - fx1, fy_bot);
                            ctx.clip();
                        }

                        ctx.translate(body.position.x, body.position.y); ctx.rotate(body.angle);
                        if (img && img.complete) { ctx.drawImage(img, -visualR, -visualR, visualR * 2, visualR * 2); }
                        ctx.restore();
                    }
                });

                // ğŸ¨ ì•ìœ ë¦¬ í…Œë‘ë¦¬ ì„  
                const frontGlass = ctx.createLinearGradient(fx1, fy_top, fx2, fy_bot); 
                frontGlass.addColorStop(0, "rgba(255, 255, 255, 0.2)"); frontGlass.addColorStop(0.5, "rgba(255, 255, 255, 0.05)"); frontGlass.addColorStop(1, "rgba(255, 255, 255, 0.1)");
                
                ctx.fillStyle = frontGlass; ctx.fillRect(fx1, fy_top, fx2 - fx1, fy_bot - fy_top);
                ctx.strokeStyle = outerColor; 
                ctx.lineWidth = 3; ctx.strokeRect(fx1, fy_top, fx2 - fx1, fy_bot - fy_top); 
            }
            requestAnimationFrame(renderLoop);
        }

        function getPointerX(e) { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; return (clientX - rect.left) * (canvas.width / rect.width); }

        function dropSnack() {
            if (isDropping || isShopOpen) return; 
            initAudio(); isDropping = true;
            const r = SNACKS[currentDroppingIndex].radius; const safeX = Math.max(r + 20, Math.min(previewX, canvas.width - r - 20));
            createSnack(safeX, dropY, currentDroppingIndex); playDropSound(); 
            
            currentDroppingIndex = upcomingSnackIndex; 
            upcomingSnackIndex = getRandomSnackIndex(); 
            
            document.getElementById('next-snack-img').src = SNACKS[upcomingSnackIndex].img;
            setTimeout(() => { isDropping = false; }, 600);
        }

        canvas.addEventListener('mousemove', (e) => { if(!isShopOpen) previewX = getPointerX(e); });
        canvas.addEventListener('mousedown', dropSnack);
        canvas.addEventListener('touchstart', (e) => { if(!isShopOpen) { e.preventDefault(); previewX = getPointerX(e); } }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { if(!isShopOpen) { e.preventDefault(); previewX = getPointerX(e); } }, {passive: false});
        canvas.addEventListener('touchend', (e) => { if(!isShopOpen) { e.preventDefault(); dropSnack(); } }, {passive: false});

        Runner.run(engineRunner, engine); renderLoop();
    </script>
</body>
</html>
